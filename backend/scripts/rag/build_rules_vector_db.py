# backend/scripts/rag/build_rules_vector_db.py

import chromadb
from sentence_transformers import SentenceTransformer

DB_PATH_VEC = "C:/Projects/Final_Project/backend/rag/vector_db"

# ========================================
# DB에 실제 존재하는 카테고리:
# - school (학교)
# - hospital (병원)
# - cafe (카페)
# - restaurant (음식점)
# - shopping (쇼핑)
# - sports (스포츠)
# ========================================

rules = [
    # ========================================
    # 1. 기본 거리 규칙 (6개)
    # ========================================
    ("school_distance", "학교는 보통 400~500m가 적정 등교 거리이며, 도보 통학 안전이 중요함"),
    ("hospital_distance", "병원 접근성은 500m 내가 일반적이며 응급 상황 대비에 필수적"),
    ("cafe_distance", "카페는 일상 이용을 위해 300~500m 정도가 편리한 도보 거리"),
    ("restaurant_distance", "음식점은 보통 300~600m 생활권에 있으면 식사 접근성이 좋음"),
    ("shopping_distance", "쇼핑시설(마트·편의점)은 300~700m 범위가 일상 장보기에 적합"),
    ("sports_distance", "체육시설(헬스장·수영장)은 300~800m가 꾸준한 이용에 적정한 거리"),
    
    # ========================================
    # 2. 학교 세부 규칙 (5개)
    # ========================================
    ("school_elementary", "초등학교는 300~500m 이내가 가장 이상적이며, 안전한 통학로 확보가 핵심"),
    ("school_middle", "중학교는 500~800m 정도가 적당하며, 대중교통 접근성도 함께 고려해야 함"),
    ("school_high", "고등학교는 500~1000m까지 허용되며, 버스 정류장 근접성이 중요함"),
    ("school_multiple", "여러 학교가 근처에 있으면 교육 환경이 우수하고 학원가가 형성되어 학습에 유리"),
    ("school_value", "학교 밀집 지역은 교육 인프라가 좋아 장기 거주 및 재산 가치에 긍정적"),
    
    # ========================================
    # 3. 병원 세부 규칙 (4개)
    # ========================================
    ("hospital_general", "종합병원은 응급 상황 대비를 위해 1km 이내가 이상적"),
    ("hospital_clinic", "동네 의원·내과는 300~500m 도보 거리가 일상 진료에 편리함"),
    ("hospital_elderly", "노인 가구는 병원 접근성이 매우 중요하며 500m 이내 필수"),
    ("hospital_family", "어린 자녀가 있는 가정은 소아과·내과 500m 이내가 긴급 상황 대비에 유리"),
    
    # ========================================
    # 4. 카페 세부 규칙 (4개)
    # ========================================
    ("cafe_daily", "카페는 일상적 이용을 위해 200~400m 이내가 가장 편리"),
    ("cafe_work", "재택근무·프리랜서는 카페 300m 이내가 업무 공간 활용에 이상적"),
    ("cafe_meeting", "약속 장소로 활용 시 500m 정도까지 허용 가능"),
    ("cafe_multiple", "카페가 여러 곳 있으면 선택의 폭이 넓어 생활 만족도 상승"),
    
    # ========================================
    # 5. 음식점 세부 규칙 (4개)
    # ========================================
    ("restaurant_daily", "일상 외식을 위해 300~500m 이내 음식점 밀집이 편리"),
    ("restaurant_delivery", "배달 음식점은 500~800m 범위가 빠른 배달에 적합"),
    ("restaurant_variety", "다양한 음식점이 모여 있으면 식사 선택권이 넓어짐"),
    ("restaurant_family", "가족 외식은 500~800m 범위 음식점이 적당"),
    
    # ========================================
    # 6. 쇼핑 세부 규칙 (5개)
    # ========================================
    ("shopping_convenience", "편의점은 200~300m 이내가 이상적이며 24시간 운영이 중요"),
    ("shopping_supermarket", "대형마트는 500~1000m 범위가 적당하며 주차 가능 여부가 핵심"),
    ("shopping_daily", "일상 장보기는 500m 이내 마트가 가장 편리"),
    ("shopping_multiple", "쇼핑시설이 여럿 있으면 가격 비교 및 다양한 물품 구매 가능"),
    ("shopping_parking", "대형 마트는 주차장 접근성이 중요하며 차량 이용 고려 필수"),
    
    # ========================================
    # 7. 스포츠 세부 규칙 (5개)
    # ========================================
    ("sports_gym", "헬스장은 300~500m가 꾸준한 운동 습관 유지에 최적"),
    ("sports_swimming", "수영장은 500~800m 이내면 정기적 이용에 적합"),
    ("sports_outdoor", "야외 체육시설은 500~1000m까지 허용되며 주말 이용에 좋음"),
    ("sports_multiple", "다양한 체육시설이 있으면 운동 선택권이 넓어 건강 관리에 유리"),
    ("sports_family", "가족 단위 운동은 500~800m 체육관이 적당"),
    
    # ========================================
    # 8. 가구 유형별 우선순위 (4개)
    # ========================================
    ("family_with_kids", "자녀가 있는 가정은 학교·음식점·쇼핑 접근성이 최우선 고려사항"),
    ("elderly_household", "노인 가구는 병원·쇼핑·음식점 근접성이 가장 중요"),
    ("single_household", "1인 가구는 카페·음식점·편의점 접근성이 생활 편의의 핵심"),
    ("working_couple", "맞벌이 부부는 음식점·쇼핑·스포츠 시설 접근성이 중요"),
    
    # ========================================
    # 9. 복합 접근성 (4개)
    # ========================================
    ("complex_education", "학교가 여럿 모여 있으면 교육 특화 지역으로 학습 환경 우수"),
    ("complex_medical", "병원이 밀집된 지역은 의료 접근성이 뛰어나 건강 관리에 유리"),
    ("complex_commercial", "음식점·카페·쇼핑이 모인 상업지는 생활 편의성이 매우 높음"),
    ("complex_lifestyle", "다양한 시설이 고루 분포하면 균형 잡힌 생활 환경 제공"),
    
    # ========================================
    # 10. 거리별 체감 (5개)
    # ========================================
    ("distance_100m", "100m는 도보 1분 거리로 매우 가까우며 일상 이용에 최적"),
    ("distance_300m", "300m는 도보 3~4분으로 가까운 편이며 자주 이용 가능한 거리"),
    ("distance_500m", "500m는 도보 6~7분으로 적당한 거리이며 정기 이용 가능"),
    ("distance_800m", "800m는 도보 10분 정도로 약간 먼 편이지만 허용 가능한 범위"),
    ("distance_1000m", "1km는 도보 12~15분으로 자전거나 차량 이용을 고려해야 함"),
    
    # ========================================
    # 11. 투자 및 가치 (3개)
    # ========================================
    ("value_school", "학교가 가까우면 교육 수요로 인해 부동산 가치가 안정적"),
    ("value_infrastructure", "다양한 생활 인프라가 갖춰진 지역은 장기 거주 가치가 높음"),
    ("value_accessibility", "모든 시설이 도보권이면 생활 만족도와 재산 가치 모두 상승"),
    
    # ========================================
    # 12. 생활 패턴별 (4개)
    # ========================================
    ("pattern_morning", "아침 출근 전 카페·음식점 300m 이내면 편리한 아침 루틴 가능"),
    ("pattern_evening", "퇴근 후 헬스장·음식점 500m 이내면 저녁 생활 패턴에 최적"),
    ("pattern_weekend", "주말 외식·쇼핑은 500~800m 거리가 여유로운 이동에 적합"),
    ("pattern_daily", "일상 생활권은 500m 이내 시설 밀집이 가장 편리함"),
]

# ✅ 한국어 임베딩 모델로 변경
embedder = SentenceTransformer("jhgan/ko-sroberta-multitask")

client = chromadb.PersistentClient(path=DB_PATH_VEC)

# 기존 컬렉션 삭제
try:
    client.delete_collection("facility_rules")
    print("⚠️ 기존 facility_rules 컬렉션 삭제")
except:
    pass

collection = client.create_collection(
    name="facility_rules",
    metadata={"hnsw:space": "cosine"}
)

# 규칙 임베딩 추가
print(f"\n📝 총 {len(rules)}개 규칙 추가 중...\n")

for i, (rid, text) in enumerate(rules, 1):
    emb = embedder.encode(text).tolist()
    collection.add(
        ids=[rid],
        embeddings=[emb],
        metadatas=[{"category": rid, "text": text}],
        documents=[text]
    )
    print(f"  [{i:2d}/{len(rules)}] ✓ {rid}")

print(f"\n{'='*60}")
print(f"✔ facility_rules 컬렉션 생성 완료!")
print(f"✔ 총 {len(rules)}개 규칙이 추가되었습니다.")
print(f"✔ 임베딩 모델: jhgan/ko-sroberta-multitask (한국어)")
print(f"{'='*60}")